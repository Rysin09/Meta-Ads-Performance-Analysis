{"$schema":"http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#","contentVersion":"1.0.0.0","parameters":{"factoryName":{"type":"string","metadata":"Data Factory name"},"ls_blob_raw":{"type":"string"},"ls_sql_analytics":{"type":"string"}},"variables":{"factoryId":"[concat('Microsoft.DataFactory/factories/', parameters('factoryName'))]"},"resources":[{"name":"[concat(parameters('factoryName'), '/p_load_blob_to_sql')]","type":"Microsoft.DataFactory/factories/pipelines","apiVersion":"2018-06-01","properties":{"activities":[{"name":"copy_ad_events","type":"Copy","dependsOn":[],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"userProperties":[],"typeProperties":{"source":{"type":"DelimitedTextSource","storeSettings":{"type":"AzureBlobStorageReadSettings","recursive":true,"enablePartitionDiscovery":false},"formatSettings":{"type":"DelimitedTextReadSettings"}},"sink":{"type":"AzureSqlSink","writeBehavior":"insert","sqlWriterUseTableLock":false},"enableStaging":false,"translator":{"type":"TabularTranslator","mappings":[{"source":{"name":"event_id","type":"String","physicalType":"String"},"sink":{"name":"event_id","type":"Int32","physicalType":"int"}},{"source":{"name":"ad_id","type":"String","physicalType":"String"},"sink":{"name":"ad_id","type":"Byte","physicalType":"tinyint"}},{"source":{"name":"user_id","type":"String","physicalType":"String"},"sink":{"name":"user_id","type":"String","physicalType":"nvarchar"}},{"source":{"name":"timestamp","type":"String","physicalType":"String"},"sink":{"name":"timestamp","type":"DateTime","physicalType":"datetime2"}},{"source":{"name":"day_of_week","type":"String","physicalType":"String"},"sink":{"name":"day_of_week","type":"String","physicalType":"nvarchar"}},{"source":{"name":"time_of_day","type":"String","physicalType":"String"},"sink":{"name":"time_of_day","type":"String","physicalType":"nvarchar"}},{"source":{"name":"event_type","type":"String","physicalType":"String"},"sink":{"name":"event_type","type":"String","physicalType":"nvarchar"}}],"typeConversion":true,"typeConversionSettings":{"allowDataTruncation":true,"treatBooleanAsNumber":false}}},"inputs":[{"referenceName":"ds_blob_ad_events","type":"DatasetReference","parameters":{}}],"outputs":[{"referenceName":"ds_sql_ad_events","type":"DatasetReference","parameters":{}}]},{"name":"copy_ads","type":"Copy","dependsOn":[],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"userProperties":[],"typeProperties":{"source":{"type":"DelimitedTextSource","storeSettings":{"type":"AzureBlobStorageReadSettings","recursive":true,"enablePartitionDiscovery":false},"formatSettings":{"type":"DelimitedTextReadSettings"}},"sink":{"type":"AzureSqlSink","writeBehavior":"insert","sqlWriterUseTableLock":false},"enableStaging":false,"translator":{"type":"TabularTranslator","mappings":[{"source":{"name":"ad_id","type":"String","physicalType":"String"},"sink":{"name":"ad_id","type":"Byte","physicalType":"tinyint"}},{"source":{"name":"campaign_id","type":"String","physicalType":"String"},"sink":{"name":"campaign_id","type":"Byte","physicalType":"tinyint"}},{"source":{"name":"ad_platform","type":"String","physicalType":"String"},"sink":{"name":"ad_platform","type":"String","physicalType":"nvarchar"}},{"source":{"name":"ad_type","type":"String","physicalType":"String"},"sink":{"name":"ad_type","type":"String","physicalType":"nvarchar"}},{"source":{"name":"target_gender","type":"String","physicalType":"String"},"sink":{"name":"target_gender","type":"String","physicalType":"nvarchar"}},{"source":{"name":"target_age_group","type":"String","physicalType":"String"},"sink":{"name":"target_age_group","type":"String","physicalType":"nvarchar"}},{"source":{"name":"target_interests","type":"String","physicalType":"String"},"sink":{"name":"target_interests","type":"String","physicalType":"nvarchar"}}],"typeConversion":true,"typeConversionSettings":{"allowDataTruncation":true,"treatBooleanAsNumber":false}}},"inputs":[{"referenceName":"ds_blob_ads","type":"DatasetReference","parameters":{}}],"outputs":[{"referenceName":"ds_sql_ads","type":"DatasetReference","parameters":{}}]},{"name":"copy_users","type":"Copy","dependsOn":[],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"userProperties":[],"typeProperties":{"source":{"type":"DelimitedTextSource","storeSettings":{"type":"AzureBlobStorageReadSettings","recursive":true,"enablePartitionDiscovery":false},"formatSettings":{"type":"DelimitedTextReadSettings"}},"sink":{"type":"AzureSqlSink","writeBehavior":"insert","sqlWriterUseTableLock":false},"enableStaging":false,"translator":{"type":"TabularTranslator","mappings":[{"source":{"name":"user_id","type":"String","physicalType":"String"},"sink":{"name":"user_id","type":"String","physicalType":"nvarchar"}},{"source":{"name":"user_gender","type":"String","physicalType":"String"},"sink":{"name":"user_gender","type":"String","physicalType":"nvarchar"}},{"source":{"name":"user_age","type":"String","physicalType":"String"},"sink":{"name":"user_age","type":"Byte","physicalType":"tinyint"}},{"source":{"name":"age_group","type":"String","physicalType":"String"},"sink":{"name":"age_group","type":"String","physicalType":"nvarchar"}},{"source":{"name":"country","type":"String","physicalType":"String"},"sink":{"name":"country","type":"String","physicalType":"nvarchar"}},{"source":{"name":"location","type":"String","physicalType":"String"},"sink":{"name":"location","type":"String","physicalType":"nvarchar"}},{"source":{"name":"interests","type":"String","physicalType":"String"},"sink":{"name":"interests","type":"String","physicalType":"nvarchar"}}],"typeConversion":true,"typeConversionSettings":{"allowDataTruncation":true,"treatBooleanAsNumber":false}}},"inputs":[{"referenceName":"ds_blob_users","type":"DatasetReference","parameters":{}}],"outputs":[{"referenceName":"ds_sql_users","type":"DatasetReference","parameters":{}}]},{"name":"Data flow1","type":"ExecuteDataFlow","dependsOn":[],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"userProperties":[],"typeProperties":{"dataflow":{"referenceName":"df_campaigns_transform","type":"DataFlowReference","parameters":{},"datasetParameters":{"source1":{},"sink1":{}}},"staging":{},"compute":{"coreCount":8,"computeType":"General"},"traceLevel":"Fine"}}],"policy":{"elapsedTimeMetric":{}},"annotations":[],"lastPublishTime":"2025-11-05T17:23:07Z"},"dependsOn":["[concat(variables('factoryId'), '/datasets/ds_blob_ad_events')]","[concat(variables('factoryId'), '/datasets/ds_sql_ad_events')]","[concat(variables('factoryId'), '/datasets/ds_blob_ads')]","[concat(variables('factoryId'), '/datasets/ds_sql_ads')]","[concat(variables('factoryId'), '/datasets/ds_blob_users')]","[concat(variables('factoryId'), '/datasets/ds_sql_users')]","[concat(variables('factoryId'), '/dataflows/df_campaigns_transform')]"]},{"name":"[concat(parameters('factoryName'), '/ds_blob_ad_events')]","type":"Microsoft.DataFactory/factories/datasets","apiVersion":"2018-06-01","properties":{"linkedServiceName":{"referenceName":"[parameters('ls_blob_raw')]","type":"LinkedServiceReference"},"annotations":[],"type":"DelimitedText","typeProperties":{"location":{"type":"AzureBlobStorageLocation","fileName":"ad_events.csv","container":"rawdata"},"columnDelimiter":",","escapeChar":"\\","firstRowAsHeader":true,"quoteChar":"\""},"schema":[{"name":"event_id","type":"String"},{"name":"ad_id","type":"String"},{"name":"user_id","type":"String"},{"name":"timestamp","type":"String"},{"name":"day_of_week","type":"String"},{"name":"time_of_day","type":"String"},{"name":"event_type","type":"String"}]},"dependsOn":[]},{"name":"[concat(parameters('factoryName'), '/ds_sql_ad_events')]","type":"Microsoft.DataFactory/factories/datasets","apiVersion":"2018-06-01","properties":{"linkedServiceName":{"referenceName":"[parameters('ls_sql_analytics')]","type":"LinkedServiceReference"},"annotations":[],"type":"AzureSqlTable","schema":[{"name":"event_id","type":"int","precision":10},{"name":"ad_id","type":"tinyint","precision":3},{"name":"user_id","type":"nvarchar"},{"name":"timestamp","type":"datetime2","scale":7},{"name":"day_of_week","type":"nvarchar"},{"name":"time_of_day","type":"nvarchar"},{"name":"event_type","type":"nvarchar"}],"typeProperties":{"schema":"dbo","table":"ad_events"}},"dependsOn":[]},{"name":"[concat(parameters('factoryName'), '/ds_blob_ads')]","type":"Microsoft.DataFactory/factories/datasets","apiVersion":"2018-06-01","properties":{"linkedServiceName":{"referenceName":"[parameters('ls_blob_raw')]","type":"LinkedServiceReference"},"annotations":[],"type":"DelimitedText","typeProperties":{"location":{"type":"AzureBlobStorageLocation","fileName":"ads.csv","container":"rawdata"},"columnDelimiter":",","escapeChar":"\\","firstRowAsHeader":true,"quoteChar":"\""},"schema":[{"name":"ad_id","type":"String"},{"name":"campaign_id","type":"String"},{"name":"ad_platform","type":"String"},{"name":"ad_type","type":"String"},{"name":"target_gender","type":"String"},{"name":"target_age_group","type":"String"},{"name":"target_interests","type":"String"}]},"dependsOn":[]},{"name":"[concat(parameters('factoryName'), '/ds_sql_ads')]","type":"Microsoft.DataFactory/factories/datasets","apiVersion":"2018-06-01","properties":{"linkedServiceName":{"referenceName":"[parameters('ls_sql_analytics')]","type":"LinkedServiceReference"},"annotations":[],"type":"AzureSqlTable","schema":[{"name":"ad_id","type":"tinyint","precision":3},{"name":"campaign_id","type":"tinyint","precision":3},{"name":"ad_platform","type":"nvarchar"},{"name":"ad_type","type":"nvarchar"},{"name":"target_gender","type":"nvarchar"},{"name":"target_age_group","type":"nvarchar"},{"name":"target_interests","type":"nvarchar"}],"typeProperties":{"schema":"dbo","table":"ads"}},"dependsOn":[]},{"name":"[concat(parameters('factoryName'), '/ds_blob_users')]","type":"Microsoft.DataFactory/factories/datasets","apiVersion":"2018-06-01","properties":{"linkedServiceName":{"referenceName":"[parameters('ls_blob_raw')]","type":"LinkedServiceReference"},"annotations":[],"type":"DelimitedText","typeProperties":{"location":{"type":"AzureBlobStorageLocation","fileName":"users.csv","container":"rawdata"},"columnDelimiter":",","escapeChar":"\\","firstRowAsHeader":true,"quoteChar":"\""},"schema":[{"name":"user_id","type":"String"},{"name":"user_gender","type":"String"},{"name":"user_age","type":"String"},{"name":"age_group","type":"String"},{"name":"country","type":"String"},{"name":"location","type":"String"},{"name":"interests","type":"String"}]},"dependsOn":[]},{"name":"[concat(parameters('factoryName'), '/ds_sql_users')]","type":"Microsoft.DataFactory/factories/datasets","apiVersion":"2018-06-01","properties":{"linkedServiceName":{"referenceName":"[parameters('ls_sql_analytics')]","type":"LinkedServiceReference"},"annotations":[],"type":"AzureSqlTable","schema":[{"name":"user_id","type":"nvarchar"},{"name":"user_gender","type":"nvarchar"},{"name":"user_age","type":"tinyint","precision":3},{"name":"age_group","type":"nvarchar"},{"name":"country","type":"nvarchar"},{"name":"location","type":"nvarchar"},{"name":"interests","type":"nvarchar"}],"typeProperties":{"schema":"dbo","table":"users"}},"dependsOn":[]},{"name":"[concat(parameters('factoryName'), '/df_campaigns_transform')]","type":"Microsoft.DataFactory/factories/dataflows","apiVersion":"2018-06-01","properties":{"type":"MappingDataFlow","typeProperties":{"sources":[{"dataset":{"referenceName":"ds_blob_campaigns","type":"DatasetReference"},"name":"source1"}],"sinks":[{"dataset":{"referenceName":"ds_sql_campaigns","type":"DatasetReference"},"name":"sink1"}],"transformations":[{"name":"ConvertDate"}],"scriptLines":["source(output(","          campaign_id as string,","          name as string,","          start_date as string,","          end_date as string,","          duration_days as string,","          total_budget as string","     ),","     allowSchemaDrift: true,","     validateSchema: false,","     ignoreNoFilesFound: false) ~> source1","source1 derive(start_date = toTimestamp(start_date, 'dd-MM-yyyy'),","          end_date = toTimestamp(end_date, 'dd-MM-yyyy')) ~> ConvertDate","ConvertDate sink(allowSchemaDrift: true,","     validateSchema: false,","     input(","          campaign_id as integer,","          name as string,","          start_date as date,","          end_date as date,","          duration_days as integer,","          total_budget as double","     ),","     deletable:false,","     insertable:true,","     updateable:false,","     upsertable:false,","     format: 'table',","     skipDuplicateMapInputs: true,","     skipDuplicateMapOutputs: true,","     errorHandlingOption: 'stopOnFirstError') ~> sink1"]}},"dependsOn":["[concat(variables('factoryId'), '/datasets/ds_blob_campaigns')]","[concat(variables('factoryId'), '/datasets/ds_sql_campaigns')]"]},{"name":"[concat(parameters('factoryName'), '/ds_blob_campaigns')]","type":"Microsoft.DataFactory/factories/datasets","apiVersion":"2018-06-01","properties":{"linkedServiceName":{"referenceName":"[parameters('ls_blob_raw')]","type":"LinkedServiceReference"},"annotations":[],"type":"DelimitedText","typeProperties":{"location":{"type":"AzureBlobStorageLocation","fileName":"campaigns.csv","container":"rawdata"},"columnDelimiter":",","escapeChar":"\\","firstRowAsHeader":true,"quoteChar":"\""},"schema":[{"name":"campaign_id","type":"String"},{"name":"name","type":"String"},{"name":"start_date","type":"String"},{"name":"end_date","type":"String"},{"name":"duration_days","type":"String"},{"name":"total_budget","type":"String"}]},"dependsOn":[]},{"name":"[concat(parameters('factoryName'), '/ds_sql_campaigns')]","type":"Microsoft.DataFactory/factories/datasets","apiVersion":"2018-06-01","properties":{"linkedServiceName":{"referenceName":"[parameters('ls_sql_analytics')]","type":"LinkedServiceReference"},"annotations":[],"type":"AzureSqlTable","schema":[{"name":"campaign_id","type":"tinyint","precision":3},{"name":"name","type":"nvarchar"},{"name":"start_date","type":"date"},{"name":"end_date","type":"date"},{"name":"duration_days","type":"tinyint","precision":3},{"name":"total_budget","type":"float","precision":15}],"typeProperties":{"schema":"dbo","table":"campaigns"}},"dependsOn":[]}]}